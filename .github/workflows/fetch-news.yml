name: Fetch News Stories

on:
  schedule:
    # Run at 6 AM and 6 PM UTC (1 AM and 1 PM EST)
    - cron: '0 6,18 * * *'
  workflow_dispatch:  # Manual trigger button in GitHub UI

jobs:
  fetch-news:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Fetch stories from API
        run: |
          echo "üåê Calling Vercel API endpoint..."
          
          # Create public directory if it doesn't exist
          mkdir -p public
          
          # Call our Next.js API endpoint (runs on Vercel)
          HTTP_CODE=$(curl -s -w "%{http_code}" -o public/stories.json \
            "https://omnidoxa.vercel.app/api/generate-static?secret=${{ secrets.GENERATE_SECRET }}")
          
          echo "üìä HTTP Status: $HTTP_CODE"
          
          # Check HTTP status
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå API returned error $HTTP_CODE"
            echo "Response content:"
            cat public/stories.json
            exit 1
          fi
          
          # Verify file exists and has content
          if [ ! -f public/stories.json ]; then
            echo "‚ùå Failed to generate stories.json"
            exit 1
          fi
          
          FILE_SIZE=$(stat -f%z public/stories.json 2>/dev/null || stat -c%s public/stories.json)
          echo "üìÅ File size: $FILE_SIZE bytes"
          
          # Check if it's valid JSON with stories
          STORY_COUNT=$(cat public/stories.json | grep -o '"total":[0-9]*' | grep -o '[0-9]*' || echo "0")
          echo "‚úÖ Generated stories.json with $STORY_COUNT stories"
          
          if [ "$STORY_COUNT" = "0" ]; then
            echo "‚ö†Ô∏è  Warning: No stories in response"
            echo "First 500 chars of response:"
            head -c 500 public/stories.json
            exit 1
          fi
          
      - name: Commit and push if changed
        run: |
          git config --global user.name 'OmniDoxa Bot'
          git config --global user.email 'bot@omnidoxa.com'
          git add public/stories.json
          
          # Only commit if there are changes
          if git diff --staged --quiet; then
            echo "üì∞ No changes to stories.json"
          else
            git commit -m "ü§ñ Auto-update news stories $(date -u +'%Y-%m-%d %H:%M UTC') [skip ci]"
            git push
            echo "‚úÖ Pushed updated stories.json"
          fi
